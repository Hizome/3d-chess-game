<script setup lang="ts">
import { onMounted, onUnmounted, ref, watch } from 'vue'
import { Chess } from 'chess.js'

// å£°æ˜å…¨å±€ Chessboard æ„é€ å‡½æ•°
declare global {
  interface Window {
    Chessboard: any
  }
}

interface Props {
  position?: string
  orientation?: 'white' | 'black'
  draggable?: boolean
  width?: number
}

const props = withDefaults(defineProps<Props>(), {
  position: 'start',
  orientation: 'white',
  draggable: true,
  width: 600
})

const emit = defineEmits<{
  'piece-drop': [source: string, target: string]
  'position-change': [fen: string]
}>()

const boardEl = ref<HTMLDivElement>()
const boardId = `chessboard-${Math.random().toString(36).substr(2, 9)}`
let board: any = null
let chess = new Chess()

// è·å–å›¾ç‰‡èµ„æºçš„URL
const getPieceImageUrl = (piece: string) => {
  return `/chessboardjs/www/img/chesspieces/wikipedia/${piece}.png`
}

// åˆå§‹åŒ–æ£‹ç›˜
const initBoard = () => {
  console.log('ğŸ¯ initBoard called')
  console.log('  - boardEl exists:', !!boardEl.value)
  console.log('  - Chessboard available:', typeof Chessboard !== 'undefined')
  console.log('  - jQuery available:', typeof jQuery !== 'undefined')

  if (!boardEl.value) {
    console.error('âŒ boardEl is not ready')
    return
  }

  if (typeof Chessboard === 'undefined') {
    console.error('âŒ Chessboard is not defined')
    // ç­‰å¾…ä¸€ä¸‹å†å°è¯•
    setTimeout(initBoard, 200)
    return
  }

  try {
    console.log('âœ… Creating chessboard instance...')
    console.log('  - boardEl.value:', boardEl.value)
    console.log('  - boardId:', boardId)

    // chessboardjs éœ€è¦ jQuery é€‰æ‹©å™¨
    const element = typeof jQuery !== 'undefined' ? jQuery(boardEl.value) : boardEl.value

    // åˆ›å»ºæ£‹ç›˜å®ä¾‹
    board = new Chessboard(element, {
      position: props.position,
      orientation: props.orientation,
      draggable: props.draggable,
      width: props.width,
      pieceTheme: getPieceImageUrl,
      onPieceDrop: (source: string, target: string) => {
        // å°è¯•ç§»åŠ¨
        const move = chess.move({
          from: source,
          to: target,
          promotion: 'q' // é»˜è®¤å‡å˜ä¸ºå
        })

        // å¦‚æœç§»åŠ¨ä¸åˆæ³•ï¼Œæ‹’ç»
        if (move === null) return false

        // ç§»åŠ¨æˆåŠŸï¼Œè§¦å‘äº‹ä»¶
        emit('piece-drop', source, target)
        emit('position-change', chess.fen())

        // æ›´æ–°æ£‹ç›˜ä½ç½®
        board.position(chess.fen())

        return true
      },
      onSnapEnd: () => {
        board.position(chess.fen())
      },
      onDragStart: (piece: string, source: string, position: string, orientation: string) => {
        // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
        if (chess.isGameOver()) return false

        // åªå…è®¸æ‹–åŠ¨å·±æ–¹æ£‹å­
        if ((chess.turn() === 'w' && piece[0] === 'b') ||
            (chess.turn() === 'b' && piece[0] === 'w')) {
          return false
        }

        return true
      }
    })
    console.log('âœ… Chessboard created successfully!', board)
  } catch (error) {
    console.error('âŒ Failed to initialize chessboard:', error)
  }
}

// æ£€æŸ¥ä¾èµ–æ˜¯å¦åŠ è½½
const waitForDependencies = (callback: () => void, retries = 50) => {
  if (retries <= 0) {
    console.error('âŒ Timeout waiting for dependencies')
    return
  }

  if (typeof Chessboard !== 'undefined' && typeof jQuery !== 'undefined') {
    console.log('âœ… All dependencies loaded')
    callback()
  } else {
    console.log(`â³ Waiting for dependencies... (${retries} retries left)`)
    setTimeout(() => waitForDependencies(callback, retries - 1), 100)
  }
}

// ç»„ä»¶æŒ‚è½½æ—¶åˆå§‹åŒ–
onMounted(() => {
  console.log('ğŸš€ Component mounted, waiting for dependencies...')
  waitForDependencies(() => {
    console.log('ğŸ¯ Starting board initialization...')
    initBoard()
  })
})

// ç»„ä»¶å¸è½½æ—¶æ¸…ç†
onUnmounted(() => {
  // chessboardjs æ²¡æœ‰æ˜¾å¼çš„ destroy æ–¹æ³•
  // æ£‹ç›˜ä¼šè‡ªåŠ¨è¢«åƒåœ¾å›æ”¶
})

// ç›‘å¬ä½ç½®å˜åŒ–
watch(() => props.position, (newPosition) => {
  if (board && newPosition) {
    board.position(newPosition)
  }
})

// ç›‘å¬æœå‘å˜åŒ–
watch(() => props.orientation, (newOrientation) => {
  if (board) {
    board.orientation(newOrientation)
  }
})

// æš´éœ²ä¸€äº›æ–¹æ³•ç»™çˆ¶ç»„ä»¶
const getPosition = () => chess.fen()
const reset = () => {
  chess = new Chess()
  if (board) {
    board.start()
  }
  emit('position-change', chess.fen())
}
const isGameOver = () => chess.isGameOver()
const isCheck = () => chess.isCheck()
const getTurn = () => chess.turn()

defineExpose({
  getPosition,
  reset,
  isGameOver,
  isCheck,
  getTurn,
  chess
})
</script>

<template>
  <div class="chessboard-2d-wrapper">
    <div :id="boardId" ref="boardEl" class="chessboard-2d"></div>
  </div>
</template>

<style scoped>
.chessboard-2d-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
  width: 100%;
  height: 100%;
  min-height: 600px;
  background-color: #f0f0f0;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.chessboard-2d {
  /* chessboardjs ä¼šè‡ªåŠ¨æ·»åŠ æ ·å¼ */
  max-width: 100%;
  max-height: 100%;
}

/* ç¡®ä¿ chessboardjs çš„æ£‹ç›˜èƒ½æ­£ç¡®æ˜¾ç¤º */
:deep(#chessboard) {
  width: 100% !important;
  max-width: 600px;
}

:deep(#chessboard .white-1e1d7) {
  /* ç™½è‰²æ ¼å­ */
}

:deep(#chessboard .black-3c85d) {
  /* é»‘è‰²æ ¼å­ */
}
</style>
